<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>٩٩٩ — معرض مع لوحات مستقلة</title>
<style>
  @font-face{font-family:'FE-Schrift';src:url('fe.ttf') format('truetype');font-display:swap}
  :root{--stage-w:540px;--stage-h:960px}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Tajawal',system-ui,sans-serif;background:#f5f6f8;color:#111}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb}
  header .wrap{max-width:1200px;margin:auto;display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 14px}
  .group{display:flex;gap:8px;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px}
  .group input,.group select,.group button{padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  .btn{cursor:pointer}.btn.primary{background:#111827;color:#fff;border-color:#111827}

  main{max-width:1200px;margin:auto;padding:16px}
  #stageCard{background:#fff;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden}
  #stageHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f9fafb}
  #stage{position:relative;width:var(--stage-w);height:var(--stage-h);margin:16px auto;background:url('bg-9x16.png') center/cover no-repeat;border-radius:14px;border:1px dashed #cbd5e1;overflow:hidden}

  /* سحب/تحجيم عام */
  .drs{position:absolute;touch-action:none}
  .handle{position:absolute;width:12px;height:12px;background:#000;border-radius:50%}
  .nw{left:-6px;top:-6px}.ne{right:-6px;top:-6px}.sw{left:-6px;bottom:-6px}.se{right:-6px;bottom:-6px}

  /* طبقات */
  .z-plate{z-index:10}  /* صور اللوحات */
  .z-text {z-index:20}  /* أرقام اللوحية */
  .z-class{z-index:25}  /* فئات اللوحات */

/* نصوص بدون تظليل وبخط FE */
.textWrap span,.price{
  font-family:'FE-Schrift',sans-serif;
  text-shadow:none;
  color:#000;
}

/* الفئات بلون أبيض */
.z-class{
  font-family:'FE-Schrift',sans-serif;
  text-shadow:none;
  color:#fff;
}

  /* السيارة */
  #carImage{width:100%;height:100%;object-fit:contain;display:block;z-index:5;position:relative}

  /* صور اللوحات */
  .plateImg{background:url('plate-real.png') center/contain no-repeat;min-width:150px;min-height:60px}
  .plateSmallImg{background:url('plate-real.png') center/contain no-repeat;min-width:120px;min-height:50px}

  /* السعر أسفل الخلفية — شفاف */
  #priceTag{position:absolute;left:50%;transform:translateX(-50%);bottom:10px;font-weight:700;font-size:18px;background:transparent;border-radius:0}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="group">
      <label>السيارة</label>
      <select id="carType">
        <option value="defender.png">Land Rover Defender</option>
        <option value="defender_octa.png">Defender Octa</option>
        <option value="g_class_brabus.png">Mercedes G-Class Brabus</option>
        <option value="g_class_white.png">Mercedes G-Class White</option>
        <option value="g_class.png">Mercedes G-Class Black</option>
        <option value="gtr_green.png">Porsche 911 GT3 RS Green</option>
        <option value="gtr_grey.png">Porsche 911 GT3 RS Grey</option>
        <option value="gtr_w.png">Porsche 911 GT3 RS White</option>
        <option value="nissan.png">Nissan Patrol Nismo</option>
        <option value="range_rover_b.png">Range Rover Black</option>
        <option value="rantha.png">Range Rover Brown</option>
        <option value="rr.png">Rolls Royce Cullinan</option>
      </select>
      <button id="btnSaveImage" class="btn primary">حفظ كصورة</button>
    </div>

    <div class="group">
      <strong>لوحة كبيرة</strong>
      <label>رقم</label><input id="numMain" placeholder="12345" style="width:100px">
      <label>حجم</label><input id="numMainFont" type="number" value="38" style="width:70px">
      <label>فئة</label><input id="clsMain" placeholder="A" style="width:70px">
      <label>حجم</label><input id="clsMainFont" type="number" value="36" style="width:70px">
    </div>

    <div class="group">
      <strong>لوحة صغيرة</strong>
      <label>رقم</label><input id="numSmall" placeholder="12345" style="width:100px">
      <label>حجم</label><input id="numSmallFont" type="number" value="22" style="width:70px">
      <label>فئة</label><input id="clsSmall" placeholder="A" style="width:70px">
      <label>حجم</label><input id="clsSmallFont" type="number" value="20" style="width:70px">
    </div>

    <div class="group">
      <label>السعر</label>
      <input id="priceInput" placeholder="120000" style="width:120px">
    </div>
  </div>
</header>

<main>
  <section id="stageCard">
    <div id="stageHead"><strong>المسرح</strong><small>كل عنصر مستقل ويمكن سحبه وتحجيمه مع حفظ تلقائي لكل سيارة.</small></div>
    <div id="stage">
      <!-- السيارة -->
      <div id="carBox" class="drs" style="left:30px;top:220px;width:400px;height:260px">
        <img id="carImage" alt="car">
        <div class="handle nw"></div><div class="handle ne"></div>
        <div class="handle sw"></div><div class="handle se"></div>
      </div>

      <!-- اللوحة الكبيرة (صورة فقط) -->
      <div id="plateBox" class="drs plateImg z-plate" style="left:110px;top:60px;width:320px;height:96px">
        <div class="handle nw"></div><div class="handle ne"></div>
        <div class="handle sw"></div><div class="handle se"></div>
      </div>
      <!-- رقم اللوحة الكبيرة -->
      <div id="plateTextWrap" class="drs textWrap z-text" style="left:170px;top:80px;width:130px;height:auto">
        <span id="plateNumber" style="font-size:38px">00000</span>
      </div>
      <!-- فئة اللوحة الكبيرة -->
      <div id="classBadgeMain" class="drs z-class" style="left:124px;top:78px;width:64px;height:74px;font-size:36px;display:flex;align-items:center;justify-content:center">A</div>

      <!-- اللوحة الصغيرة (صورة فقط) -->
      <div id="plateSmallBox" class="drs plateSmallImg z-plate" style="left:220px;top:330px;width:170px;height:56px">
        <div class="handle nw"></div><div class="handle ne"></div>
        <div class="handle sw"></div><div class="handle se"></div>
      </div>
      <!-- رقم اللوحة الصغيرة -->
      <div id="plateSmallTextWrap" class="drs textWrap z-text" style="left:252px;top:342px;width:110px;height:auto">
        <span id="plateNumberSmall" style="font-size:22px">00000</span>
      </div>
      <!-- فئة اللوحة الصغيرة -->
      <div id="classBadgeSmall" class="drs z-class" style="left:228px;top:338px;width:40px;height:34px;font-size:20px;display:flex;align-items:center;justify-content:center">A</div>

      <!-- السعر -->
      <div id="priceTag" class="drs price">السعر : درهم</div>
    </div>
  </section>
</main>

<!-- للحفظ كصورة -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  /* تحميل صورة السيارة المختارة */
  const carType=document.getElementById('carType');
  const carImg=document.getElementById('carImage');
  function setCar(){ carImg.src=carType.value || ''; }
  carType.addEventListener('change',()=>{ setCar(); loadState(); });

  /* عناصر الإدخال */
  const numMain=document.getElementById('numMain');
  const numMainFont=document.getElementById('numMainFont');
  const numSmall=document.getElementById('numSmall');
  const numSmallFont=document.getElementById('numSmallFont');
  const clsMain=document.getElementById('clsMain');
  const clsMainFont=document.getElementById('clsMainFont');
  const clsSmall=document.getElementById('clsSmall');
  const clsSmallFont=document.getElementById('clsSmallFont');
  const priceInput=document.getElementById('priceInput');

  /* عناصر المسرح */
  const plateNumber=document.getElementById('plateNumber');
  const plateNumberSmall=document.getElementById('plateNumberSmall');
  const classBadgeMain=document.getElementById('classBadgeMain');
  const classBadgeSmall=document.getElementById('classBadgeSmall');
  const priceTag=document.getElementById('priceTag');

  /* دوال السحب/التحجيم */
  const stage=document.getElementById('stage');
  function makeDrs(box,{resizable=true}={}){
    const handles=box.querySelectorAll('.handle');
    let mode='move',startX=0,startY=0,start={x:0,y:0,w:0,h:0,dir:null};
    function begin(e,m,dir){ e.preventDefault(); mode=m; start.dir=dir||null;
      const p=e.touches?e.touches[0]:e; startX=p.clientX; startY=p.clientY;
      const r=box.getBoundingClientRect(), s=stage.getBoundingClientRect();
      start.x=r.left-s.left; start.y=r.top-s.top; start.w=r.width; start.h=r.height;
      window.addEventListener(e.touches?'touchmove':'mousemove',moving,{passive:false});
      window.addEventListener(e.touches?'touchend':'mouseup',end,{once:true});
    }
    function moving(e){
      e.preventDefault(); const p=e.touches?e.touches[0]:e; const dx=p.clientX-startX, dy=p.clientY-startY;
      if(mode==='move'){ box.style.left=Math.max(0,start.x+dx)+'px'; box.style.top=Math.max(0,start.y+dy)+'px'; }
      else{ let l=start.x,t=start.y,w=start.w,h=start.h;
        if(start.dir==='se'){w+=dx;h+=dy}
        if(start.dir==='ne'){w+=dx;h-=dy;t+=dy}
        if(start.dir==='sw'){w-=dx;h+=dy;l+=dx}
        if(start.dir==='nw'){w-=dx;h-=dy;l+=dx;t+=dy}
        box.style.left=Math.max(0,l)+'px'; box.style.top=Math.max(0,t)+'px';
        box.style.width=Math.max(30,w)+'px'; box.style.height=Math.max(24,h)+'px'; }
    }
    function end(){ window.removeEventListener('mousemove',moving); window.removeEventListener('touchmove',moving); saveState(); }
    box.addEventListener('mousedown',ev=>{ if(resizable && ev.target.classList.contains('handle'))return; begin(ev,'move'); });
    box.addEventListener('touchstart',ev=>{ if(resizable && ev.target.classList.contains('handle'))return; begin(ev,'move'); },{passive:false});
    if(resizable){ handles.forEach(h=>{ const d=[...h.classList].find(c=>['nw','ne','sw','se'].includes(c));
      h.addEventListener('mousedown',ev=>begin(ev,'resize',d));
      h.addEventListener('touchstart',ev=>begin(ev,'resize',d),{passive:false}); });}
  }

  /* تطبيق السحب/التحجيم */
  makeDrs(document.getElementById('carBox'));
  makeDrs(document.getElementById('plateBox'));
  makeDrs(document.getElementById('plateSmallBox'));
  makeDrs(document.getElementById('plateTextWrap'),{resizable:false});
  makeDrs(document.getElementById('plateSmallTextWrap'),{resizable:false});
  makeDrs(document.getElementById('classBadgeMain'),{resizable:false});
  makeDrs(document.getElementById('classBadgeSmall'),{resizable:false});
  makeDrs(document.getElementById('priceTag'),{resizable:false});

  /* تزامن النصوص والأحجام */
  function syncMain(){ plateNumber.textContent=(numMain.value||'').trim()||'00000'; plateNumber.style.fontSize=(+numMainFont.value||38)+'px'; saveState(); }
  function syncSmall(){ plateNumberSmall.textContent=(numSmall.value||'').trim()||'00000'; plateNumberSmall.style.fontSize=(+numSmallFont.value||22)+'px'; saveState(); }
  function syncClassMain(){ classBadgeMain.textContent=(clsMain.value||'').trim(); classBadgeMain.style.fontSize=(+clsMainFont.value||36)+'px'; saveState(); }
  function syncClassSmall(){ classBadgeSmall.textContent=(clsSmall.value||'').trim(); classBadgeSmall.style.fontSize=(+clsSmallFont.value||20)+'px'; saveState(); }
  function syncPrice(){ priceTag.textContent=(priceInput.value?`السعر : ${priceInput.value} درهم`:'السعر : درهم'); saveState(); }
  [numMain,numMainFont].forEach(e=>e.addEventListener('input',syncMain));
  [numSmall,numSmallFont].forEach(e=>e.addEventListener('input',syncSmall));
  [clsMain,clsMainFont].forEach(e=>e.addEventListener('input',syncClassMain));
  [clsSmall,clsSmallFont].forEach(e=>e.addEventListener('input',syncClassSmall));
  priceInput.addEventListener('input',syncPrice);

  /* حفظ/تحميل لكل سيارة */
  function key(){ return 'carState_v5_'+carType.value; }
  function collect(){
    return {
      price:priceInput.value,
      numMain:numMain.value, numMainFont:numMainFont.value,
      numSmall:numSmall.value, numSmallFont:numSmallFont.value,
      clsMain:clsMain.value, clsMainFont:clsMainFont.value,
      clsSmall:clsSmall.value, clsSmallFont:clsSmallFont.value,
      nodes:{
        car:document.getElementById('carBox').style.cssText,
        plate:document.getElementById('plateBox').style.cssText,
        plateText:document.getElementById('plateTextWrap').style.cssText,
        classMain:document.getElementById('classBadgeMain').style.cssText,
        plateSmall:document.getElementById('plateSmallBox').style.cssText,
        plateSmallText:document.getElementById('plateSmallTextWrap').style.cssText,
        classSmall:document.getElementById('classBadgeSmall').style.cssText,
        price:document.getElementById('priceTag').style.cssText
      }
    };
  }
  function saveState(){ localStorage.setItem(key(), JSON.stringify(collect())); }
  function loadState(){
    const raw=localStorage.getItem(key());
    if(!raw){ setCar(); syncMain(); syncSmall(); syncClassMain(); syncClassSmall(); syncPrice(); return; }
    const s=JSON.parse(raw); setCar();
    priceInput.value=s.price||'';
    numMain.value=s.numMain||''; numMainFont.value=s.numMainFont||38;
    numSmall.value=s.numSmall||''; numSmallFont.value=s.numSmallFont||22;
    clsMain.value=s.clsMain||'A'; clsMainFont.value=s.clsMainFont||36;
    clsSmall.value=s.clsSmall||'A'; clsSmallFont.value=s.clsSmallFont||20;
    syncMain(); syncSmall(); syncClassMain(); syncClassSmall(); syncPrice();
    if(s.nodes){
      document.getElementById('carBox').style.cssText=s.nodes.car||'';
      document.getElementById('plateBox').style.cssText=s.nodes.plate||'';
      document.getElementById('plateTextWrap').style.cssText=s.nodes.plateText||'';
      document.getElementById('classBadgeMain').style.cssText=s.nodes.classMain||'';
      document.getElementById('plateSmallBox').style.cssText=s.nodes.plateSmall||'';
      document.getElementById('plateSmallTextWrap').style.cssText=s.nodes.plateSmallText||'';
      document.getElementById('classBadgeSmall').style.cssText=s.nodes.classSmall||'';
      document.getElementById('priceTag').style.cssText=s.nodes.price||'';
    }
  }

  /* حفظ كصورة */
  document.getElementById('btnSaveImage').addEventListener('click',()=>{
    html2canvas(document.getElementById('stage'),{backgroundColor:null,useCORS:true}).then(c=>{
      const a=document.createElement('a'); a.download='car_'+carType.value.replace(/\.[a-z]+$/,'')+'.png'; a.href=c.toDataURL(); a.click();
    });
  });

  window.addEventListener('DOMContentLoaded',()=>{ setCar(); loadState(); });
</script>
</body>
</html>
